#!/bin/sh
# Copyright 2007-2009 Roy Marples
# All rights reserved

# dnsmasq subscriber for resolvconf

# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
#     * Redistributions of source code must retain the above copyright
#       notice, this list of conditions and the following disclaimer.
#     * Redistributions in binary form must reproduce the above
#       copyright notice, this list of conditions and the following
#       disclaimer in the documentation and/or other materials provided
#       with the distribution.
#
# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
# "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
# LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
# A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
# OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
# SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
# LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
# DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
# THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
# (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
# OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

[ -f "@SYSCONFDIR@"/resolvconf.conf ] || exit 0
. "@SYSCONFDIR@/resolvconf.conf" || exit 1
[ -z "${dnsmasq_conf}" -o -z "${dnsmasq_resolv}" ] && exit 0
eval "$(${RESOLVCONF:-resolvconf} -v)"

PREFIX=@PREFIX@
DNSMASQPID="${dnsmasq_pid:-/var/run/dnsmasq.pid}"

NEWCONF="# Generated by resolvconf\n"
NEWRESOLV="${NEWCONF}"

# Using DBUS means that we never have to restart the daemon
# This is important as it means we should not drop DNS queries
# whilst changing DNS options around. However, DBUS support is optional
# so we need to validate a few things first.
# Check for DBus support in the binary

DBUS=no
DBUSPID="${dbus_pid:-/var/run/dbus/dbus.pid}"
[ -s "${DBUSPID}" ] || DBUSPID=/var/run/dbus.pid
[ -s "${DBUSPID}" ] || DBUSPID=/var/run/dbus/pid
if [ -s "${DBUSPID}" -a -s ${DNSMASQPID} ]; then
	if dnsmasq --version 2>/dev/null | \
		grep -q "^Compile time options.*[[:space:]]DBus[[:space:]]"
	then
		# Sanity - check that dnsmasq and dbus are running
		if kill -0 $(cat "${DBUSPID}") 2>/dev/null && \
			kill -0 $(cat ${DNSMASQPID}) 2>/dev/null
		then
			DBUS=yes
			NEWCONF="${NEWCONF}\n# Domain specific servers will"
			NEWCONF="${NEWCONF} be sent over dbus\nenable-dbus\n"
		fi
	fi
fi

for N in ${NAMESERVERS}; do
	case "\n${NEWRESOLV}\n" in
	*"\nnameserver ${N}\n");;
	*) NEWRESOLV="${NEWRESOLV}nameserver ${N}\n";;
	esac
done

DBUSDEST=
for D in ${DOMAINS}; do
	DN="${D%%:*}"
	NS="${D#*:}"
	while [ -n "${NS}" ]; do
		if [ "${DBUS}" = "yes" ]; then
			SIFS=${IFS-y} OIFS=$IFS
			IFS=.
			set -- ${NS%%,*}
			NUM="0x$(printf "%02x" $1 $2 $3 $4)"
			if [ "${SIFS}" = "y" ]; then
				unset IFS
			else
				IFS=$OIFS
			fi
			DBUSDEST="${DBUSDEST} uint32:$(printf "%u" ${NUM})"
			DBUSDEST="${DBUSDEST} string:${DN}"
		else
			NEWCONF="${NEWCONF}server=/${DN}/${NS%%,*}\n"
		fi
		[ "${NS}" = "${NS#*,}" ] && break
		NS="${NS#*,}"
	done
done

RELOAD="no"
if [ -f "${dnsmasq_conf}" ]; then
	if [ "$(cat "${dnsmasq_conf}")" != "$(printf "${NEWCONF}")" ]; then
		RELOAD="yes"
		printf "${NEWCONF}" > "${dnsmasq_conf}"
	fi
else
	RELOAD="yes"
	printf "${NEWCONF}" > "${dnsmasq_conf}"
fi
if [ -f "${dnsmasq_resolv}" ]; then
	if [ "$(cat "${dnsmasq_resolv}")" != "$(printf "${NEWRESOLV}")" ]; then
		RELOAD="yes"
		printf "${NEWRESOLV}" > "${dnsmasq_resolv}"
	fi
else
	# dnsmasq polls this file so no need to set RELOAD="yes"
	printf "${NEWRESOLV}" > "${dnsmasq_resolv}"
fi

[ "${RELOAD}" = "yes" ] && resolvconf -s dnsmasq restart
if [ "${DBUS}" = "yes" ]; then
	[ "${RELOAD}" != "yes" ] && kill -HUP $(cat ${DNSMASQPID})
	# Send even if empty so old servers are cleared
	dbus-send --system --dest=uk.org.thekelleys.dnsmasq \
 		/uk/org/thekelleys/dnsmasq uk.org.thekelleys.SetServers \
  		${DBUSDEST}
fi
