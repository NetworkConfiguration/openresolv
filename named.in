#!/bin/sh
# Copyright 2007-2009 Roy Marples <roy@marples.name>
# All rights reserved

# named subscriber for resolvconf

# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
#     * Redistributions of source code must retain the above copyright
#       notice, this list of conditions and the following disclaimer.
#     * Redistributions in binary form must reproduce the above
#       copyright notice, this list of conditions and the following
#       disclaimer in the documentation and/or other materials provided
#       with the distribution.
#
# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
# "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
# LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
# A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
# OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
# SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
# LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
# DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
# THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
# (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
# OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

[ -f "@SYSCONFDIR@"/resolvconf.conf ] || exit 0
. "@SYSCONFDIR@/resolvconf.conf" || exit 1
[ -z "${named_zones}" -o -z "${named_options}" ] && exit 0
eval "$("${RESOLVCONF:-resolvconf}" -v)"

NEWOPTIONS="# Generated by resolvconf\n"
NEWZONES="${NEWOPTIONS}"
FORWARD=
for N in ${NAMESERVERS}; do
	case "${FORWARD}" in
	*"\n\t${N};"*);;
	*) FORWARD="${FORWARD}\n\t${N};";;
	esac
done
if [ -n "${FORWARD}" ]; then
	NEWOPTIONS="${NEWOPTIONS}forward first;\nforwarders {${FORWARD}\n};\n"
fi

for D in ${DOMAINS}; do
	NEWZONES="${NEWZONES}zone \"${D%%:*}\" {\n"
	NEWZONES="${NEWZONES}\ttype forward;\n"
	NEWZONES="${NEWZONES}\tforward first;\n\tforwarders {\n"
	NS="${D#*:}"
	while [ -n "${NS}" ]; do
		NEWZONES="${NEWZONES}\t\t${NS%%,*};\n"
		[ "${NS}" = "${NS#*,}" ] && break
		NS="${NS#*,}"
	done
	NEWZONES="${NEWZONES}\t};\n};\n"
done

# No point in changing files or reloading bind if the end result has not
# changed
RELOAD="no"
if [ -f "${named_options}" ]; then 
	if [ "$(cat "${named_options}")" != "$(printf "${NEWOPTIONS}")" ]; then
		printf "${NEWOPTIONS}" > "${named_options}"
		RELOAD="yes"
	fi
else
	printf "${NEWOPTIONS}" > "${named_options}"
	RELOAD="yes"
fi
if [ -f "${named_zones}" ]; then
	if [ "$(cat "${named_zones}")" != "$(printf "${NEWZONES}")" ]; then
		printf "${NEWZONES}" > "${named_zones}"
		RELOAD="yes"
	fi
else
	printf "${NEWZONES}" > "${named_zones}"
	RELOAD="yes"
fi

[ "${RELOAD}" = "yes" ] && resolvconf -s named restart
exit 0
